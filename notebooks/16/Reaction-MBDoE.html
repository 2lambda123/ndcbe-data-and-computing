
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>16.1. Model-Based Design of Experiments &#8212; Data and Computing for Chemical Engineers</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/16/Reaction-MBDoE';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Fall 2022" href="../../fall2022/home.html" />
    <link rel="prev" title="16. Design of Experiments" href="design_of_experiments.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/cbe_logo.jpg" class="logo__image only-light" alt="Data and Computing for Chemical Engineers - Home"/>
    <script>document.write(`<img src="../../_static/cbe_logo.jpg" class="logo__image only-dark" alt="Data and Computing for Chemical Engineers - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Data and Computing for Engineers
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Python Programming</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01/Python-Primer.html">1. Python Primer</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01/Jupyter-Notebooks.html">1.1. Welcome to Jupyter Notebooks and Vocareum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Python-Basics-I-Variables-Strings-Bugs.html">1.2. Python Basics I: Variables, Strings, and Bugs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Flow-control.html">1.3. Python Basics II: Loopy Logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Python-Basics-III-Lists-Dictionaries-Enumeration.html">1.4. Python Basics III: Lists, Dictionaries, and Enumeration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Functions-and-Scope.html">1.5. Functions and Scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Recursion.html">1.6. Recursion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Pseudocode.html">1.7. Pseudocode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Example-High-Low-Game.html">1.8. High/Low Guess My Number Game</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Modules-and-Files.html">1.9. Modules and Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/NumPy.html">1.10. Linear Algebra with Numpy and Scipy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Matplotlib.html">1.11. Visualization with matplotlib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Pandas.html">1.12. Manipulating Data with Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Functions-as-Arguments.html">1.13. Functions as Arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Testing-and-Debugging.html">1.14. Testing and Debugging in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/Publication-Quality-Figures.html">1.15. Preparing Publication Quality Figures in Python</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../02/advanced_python.html">2. Advanced Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Numerical Methods</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../03/linear_algebra.html">3. Linear Algebra Primer</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../03/chapter1.html">3.1. Chapter 1: Math Fundamentals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/chapter2.html">3.2. Chapter 2: Intro to Linear Algebra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/chapter3.html">3.3. Chapter 3: Computational linear algebra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/chapter4.html">3.4. Chapter 4: Geometric Aspects of Linear Algebra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/chapter5.html">3.5. Chapter 5: Linear Transformations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/chapter6.html">3.6. Chapter 6: Theoretical Linear Algebra</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../04/linear_algebra.html">4. Applied Linear Algebra</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../04/Modeling-Systems-of-Linear-Equations.html">4.1. Modeling Systems of Linear Equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/Gauss-Elimination.html">4.2. Gaussian Elimination</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/Invertible-Matrix-Theorem-and-Gauss-Example.html">4.3. Invertible Matrix Theorem and Gaussian Elimination Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/LU-Decomposition.html">4.4. LU Decomposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/Condition-Number.html">4.5. Errors in Linear Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/Example-Atomic-Mass-Balances.html">4.6. Example: Mass Balances and Linear Algebra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/Linear-Algebra-in-Numpy.html">4.7. Linear Algebra Review and SciPy Basics</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../05/algorithms.html">5. Algorithm Building Blocks</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../05/Taylor-Series.html">5.1. Taylor Series Approximations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/Finite-Difference.html">5.2. Finite Difference Derivative Approximations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/Example-Heating-a-Metal-Slab.html">5.3. Example: Heating a Metal Slab</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../06/nonlinear_systems.html">6. Nonlinear Systems of Equations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../06/Modeling-Systems-of-Nonlinear-Equations.html">6.1. Modeling Systems of Nonlinear Equations: Flash Calculation Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/Newton-Raphson-Method-in-One-Dimension.html">6.2. Newton-Raphson Method in One Dimension</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/More-Newton-Type-Methods.html">6.3. More Newton-Type Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/Convergence-Analysis-for-Newton-Raphson-Methods.html">6.4. Convergence Analysis for Newton-Raphson Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/Newton-Raphson-Methods-for-Systems-of-Equations.html">6.5. Newton-Raphson Methods for Systems of Equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/Newton-Methods-in-Scipy.html">6.6. Newton Methods in Scipy</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../07/integration.html">7. Numeric Integration</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../07/Intro-and-Newton-Cotes.html">7.1. Introduction and Newton-Cotes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/Gauss-Quadrature.html">7.2. Gauss Quadrature</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/Scipy-Library-Adaptive-Methods-for-Newton-Cotes-and-Gauss-Quadrature.html">7.3. Scipy Library: Adaptive Methods for Newton-Cotes and Gauss Quadrature</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/Application-Inertial-Navigation-Systems.html">7.4. Application: Inertial Navigation Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/Forward-and-Backward-Euler.html">7.5. Forward and Backward Euler Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/Trapezoid-Rule.html">7.6. Crank-Nicolson (Trapezoid Rule)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/Stability-Analysis.html">7.7. Stability Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/Explicit-Runge-Kutta.html">7.8. Explicit Range Kutta Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/Systems-of-Differential-Equations-and-Scipy.html">7.9. Systems of Differential Equations and Scipy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/Example-Reaction-Rates.html">7.10. Example: Reaction Rates</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../08/optimization.html">8. Continuous Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../08/Pyomo-Basics.html">8.1. Pyomo Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08/Electricity-Market-Optimization.html">8.2. Electricity Market Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08/Flash-Calculations-in-Pyomo.html">8.3. Flash Calculations in Pyomo</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Analysis</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../09/stats.html">9. Descriptive Statistics and Visualization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../09/Sampling.html">9.1. Sampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/Summary-Statistics.html">9.2. Summary Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/Visualizing-Data.html">9.3. Visualizing Data</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../10/probability.html">10. Probability Theory</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../10/Probability-Basics.html">10.1. Basic Ideas of Probability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/Random-Variables.html">10.2. Random Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/Jointly-Distributed-Random-Variables.html">10.3. Jointly Distributed Random Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/Jointly-Continuous-Random-Variables.html">10.4. Jointly Continuous Random Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/Practice-Problems.html">10.5. Practice Problems</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../11/distributions.html">11. Common Probability Distributions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../11/Bernoulli-Probability-Distribution.html">11.1. Bernoulli Probability Distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../11/Binomial-Probability-Distribtuion.html">11.2. Binomial Probability Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../11/Poisson-Probability-Distribution.html">11.3. Poisson Probability Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../11/Normal-Probability-Distribution.html">11.4. Normal Probability Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../11/Common-Probability-Distributions-Summary.html">11.5. Summary</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../12/uncertainty.html">12. Uncertainty and Error Propagation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../12/Measurement-Error.html">12.1. Measurement Error</a></li>
<li class="toctree-l2"><a class="reference internal" href="../12/Error-Propagation.html">12.2. Error Propagation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../12/Measuring-Flowrate-Example.html">12.3. Measuring Flowrate Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../12/Car-and-Incline-Example.html">12.4. Car and Incline Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../12/Simulation.html">12.5. Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../12/Monte-Carlo-Error-Propogation.html">12.6. Monte Carlo Error Propagation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../12/Practice-Problems.html">12.7. Practice Problems</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../13/inference.html">13. Statistical Inference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../13/Central-Limit-Theorem.html">13.1. Central Limit Theorem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13/Standard-Normal-Distribution.html">13.2. Standard Normal Distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13/Confidence-Intervals.html">13.3. Confidence Intervals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13/Students-t-Distribution.html">13.4. Student’s t-Distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13/Hypothesis-Testing-Basics.html">13.5. Hypothesis Testing Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13/Flavors-of-Hypothesis-Testing.html">13.6. Flavors of Hypothesis Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13/Type-I-and-Type-II-Errors.html">13.7. Type I and Type II Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13/Statistical-Power-Basics.html">13.8. Statistical Power Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13/Statistical-Power-in-Python.html">13.9. Statistical Power in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13/Statistical-Power-Practice-Problems.html">13.10. Statistical Power Practice Problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13/Bootstrap-Confidence-Intervals.html">13.11. Bootstrap Confidence Intervals</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../14/regression.html">14. Multivariate Linear Regression</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../14/Correlation-Covariance-and-Independence.html">14.1. Correlation, Covariance, and Independence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../14/Least-Squares-Line.html">14.2. Simple Least Squares</a></li>
<li class="toctree-l2"><a class="reference internal" href="../14/Ordinary-Least-Squares-Linear-Regression.html">14.3. Ordinary Least Squares Linear Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../14/Residual-Analysis.html">14.4. Residual Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../14/Regression-Assumption-Examples.html">14.5. Regression Assumption Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../14/Uncertainty-Analysis-and-Statistical-Inference.html">14.6. Uncertainty Analysis and Statistical Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../14/Multivariate-Linear-Regression.html">14.7. Multivariate Linear Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../14/Linear-Regression-Practice-Problems.html">14.8. Linear Regression Practice Problems</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../15/advanced_regression.html">15. Nonlinear Regression</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../15/Transformations-and-Linear-Regression.html">15.1. Transformations and Linear Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../15/Weighted-Regression.html">15.2. Weighted Linear Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../15/Nonlinear-Regression.html">15.3. Nonlinear Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../15/Nonlinear-Regression-Practice-Problem.html">15.4. Nonlinear Regression Practice Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../15/Monte-Carlo-Uncertainty-Analysis-for-Nonlinear-Regression.html">15.5. Monte Carlo Uncertainty Analysis for Nonlinear Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../15/Nonlinear-Case-Study-Adsorptive-Membranes.html">15.6. Nonlinear Regression Case Study: Adsorptive Nanoporous Membranes</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="design_of_experiments.html">16. Design of Experiments</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">16.1. Model-Based Design of Experiments</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Extra Information</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../fall2022/home.html">Fall 2022</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../fall2022/syllabus.html">Syllabus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fall2022/schedule.html">Fall 2022 Schedule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fall2022/project1.html">Project 1: Computating for Problem Solving (Fall 2022)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fall2022/project2.html">Project 2: Data Analysis (Fall 2022)</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../fall2023/home.html">Fall 2023</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../fall2023/syllabus.html">Syllabus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fall2023/schedule.html">Schedule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fall2023/project.html">Semester Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/ProblemSet1_F23.html">Problem Set 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/ProblemSet2_F23.html">Problem Set 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/ProblemSet3_F23.html">Problem Set 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/ProblemSet4_F23.html">Problem Set 4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/ProblemSet5_F23.html">Problem Set 5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/ProblemSet6_F23.html">Problem Set 6</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contrib/contribute.html">Contributed Examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Biotransport-Entrance-Length.html">Estimating the Entrance Length of Channel Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Non_Isothermal_PBR.html">Non-Isothermal Packed Bed Reactor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Ficks_Law.html">Solving Fick’s Second Law Using Numeric Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Stochastic-Kinetics.html">Stochastic Simulation of Chemical Reactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Spaghettification.html">Spaghettification of the Magic School Bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Alcohol-Pharmacokinetics.html">Alcohol Pharmacokinetics and  Blood Alcohol Content % Modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/McCabe-Thiele.html">Plotting McCabe-Thiele diagram through computational methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Wastewater-Treatment-Mass-Balance.html">Example of Mass Balance Problem in Wastewater Treatment Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Filtration.html">Filtration of a Yeast Suspension</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Fraction_of_Molecular_Collisions.html">Calculating Fraction of Molecular Collisions</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/ndcbe/data-and-computing/blob/master/notebooks/16/Reaction-MBDoE.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ndcbe/data-and-computing" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ndcbe/data-and-computing/issues/new?title=Issue%20on%20page%20%2Fnotebooks/16/Reaction-MBDoE.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/16/Reaction-MBDoE.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Model-Based Design of Experiments</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">16.1.1. Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-modules">16.1.2. Import Modules</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-model-for-reaction-kinetics-example">16.1.3. Mathematical Model for Reaction Kinetics Example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-synthetic-experimental-dataset">16.1.4. Generate Synthetic Experimental Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-nonlinear-regression">16.1.5. Perform Nonlinear Regression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solve-nonlinear-least-squares-problem">16.1.5.1. Solve Nonlinear Least Squares Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-results">16.1.5.2. Visualize Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-uncertainty">16.1.5.3. Estimate Uncertainty</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fisher-information-matrix">16.1.6. Fisher Information Matrix</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-sensitivity">16.1.6.1. Model Sensitivity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fim-by-measurement-type">16.1.6.2. FIM By Measurement Type</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combined-fim">16.1.6.3. Combined FIM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#eigendecomposition">16.1.6.4. Eigendecomposition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#covariance-matrix-of-regressed-paramters">16.1.6.5. Covariance Matrix of Regressed Paramters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-confidence-ellipses">16.1.6.6. Visualizing Confidence Ellipses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion">16.1.6.7. Discussion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-identifiability">16.1.6.8. Model Identifiability</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optimality-metrics">16.1.6.9. Optimality metrics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-the-next-best-experiment">16.1.7. What is the next best experiment?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-optimality">16.1.7.1. A-Optimality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-optimality">16.1.7.2. D-Optimality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#e-optimality">16.1.7.3. E-Optimality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">16.1.7.4. Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#take-away-messages">16.1.8. Take Away Messages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-reading">16.1.9. Recommended Reading</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="model-based-design-of-experiments">
<h1><span class="section-number">16.1. </span>Model-Based Design of Experiments<a class="headerlink" href="#model-based-design-of-experiments" title="Link to this heading">#</a></h1>
<p>This notebook is based on an example from:</p>
<p><a class="reference external" href="https://github.com/jialuw96">Jialu Wang</a> and <a class="reference external" href="https://github.com/adowling2">Alexander Dowling</a> (2022), <a class="reference external" href="https://aiche.onlinelibrary.wiley.com/doi/full/10.1002/aic.17813">Pyomo.DoE: An Open-Source Package for Model-Based Design of Experiments in Python</a> . <em>AIChE Journal</em>, 68(12), e17813.</p>
<section id="learning-objectives">
<h2><span class="section-number">16.1.1. </span>Learning Objectives<a class="headerlink" href="#learning-objectives" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Practice nonlinear regression basics on a reaction kinetics example</p></li>
<li><p>Interpret eigendecomposition of Fisher information matrix to determine which paramters (if any) are not identifiable</p></li>
<li><p>Use A-, D-, and E-optimality to recommend the next experiment that maximizes information gain</p></li>
</ul>
</section>
<section id="import-modules">
<h2><span class="section-number">16.1.2. </span>Import Modules<a class="headerlink" href="#import-modules" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">optimize</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="k">as</span> <span class="nn">linalg</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="mathematical-model-for-reaction-kinetics-example">
<h2><span class="section-number">16.1.3. </span>Mathematical Model for Reaction Kinetics Example<a class="headerlink" href="#mathematical-model-for-reaction-kinetics-example" title="Link to this heading">#</a></h2>
<p>Consider two chemical reactions that convert molecule <span class="math notranslate nohighlight">\(A\)</span> to desired product <span class="math notranslate nohighlight">\(B\)</span> and a less valuable side-product <span class="math notranslate nohighlight">\(C\)</span>.</p>
<p><span class="math notranslate nohighlight">\(A \overset{k_1}{\rightarrow} B \overset{k_2}{\rightarrow} C\)</span></p>
<p>Our ultimate goal is to design a large-scale continous reactor that maximizes the production of <span class="math notranslate nohighlight">\(B\)</span>. This general sequential reactions problem is widely applicable to CO<span class="math notranslate nohighlight">\(_2\)</span> capture and industry more broadly (petrochemicals, pharmasuticals, etc.).</p>
<p>The rate laws for these two chemical reactions are:</p>
<p><span class="math notranslate nohighlight">\(r_A = -k_1 C_A\)</span></p>
<p><span class="math notranslate nohighlight">\(r_B = k_1 C_A - k_2 C_B\)</span></p>
<p><span class="math notranslate nohighlight">\(r_C = k_2 C_B\)</span></p>
<p>Here, <span class="math notranslate nohighlight">\(C_A\)</span>, <span class="math notranslate nohighlight">\(C_B\)</span>, and <span class="math notranslate nohighlight">\(C_C\)</span> are the concentrations of each species. The rate constants <span class="math notranslate nohighlight">\(k_1\)</span> and <span class="math notranslate nohighlight">\(k_2\)</span> depend on temperature as follows:</p>
<p><span class="math notranslate nohighlight">\(k_1 = A_1 \exp{\frac{-E_1}{R T}}\)</span></p>
<p><span class="math notranslate nohighlight">\(k_2 = A_2 \exp{\frac{-E_2}{R T}}\)</span></p>
<p><span class="math notranslate nohighlight">\(A_1, A_2, E_1\)</span>, and <span class="math notranslate nohighlight">\(E_2\)</span> are fitted model parameters. <span class="math notranslate nohighlight">\(R\)</span> is the ideal-gas constant and <span class="math notranslate nohighlight">\(T\)</span> is absolute temperature.</p>
<p>The concenration in a <strong>batch reactor</strong> evolve with time per the following differential equations:</p>
<div class="math notranslate nohighlight">
\[ \frac{d C_A}{dt} = r_A = -k_1 C_A \]</div>
<div class="math notranslate nohighlight">
\[ \frac{d C_B}{dt} = r_B = k_1 C_A - k_2 C_B \]</div>
<div class="math notranslate nohighlight">
\[ \frac{d C_C}{dt} = r_C = k_2 C_B \]</div>
<p>This is a linear system of differential equations. Assuming the feed is only species <span class="math notranslate nohighlight">\(A\)</span>, i.e.,</p>
<div class="math notranslate nohighlight">
\[C_A(t=0) = C_{A0} \quad C_B(t=0) = 0 \quad C_C(t=0) = 0\]</div>
<p>When the temperature is constant, it leads to the following analytic solution:</p>
<div class="math notranslate nohighlight">
\[C_A(t) = C_{A,0} \exp(-k_1 t)\]</div>
<div class="math notranslate nohighlight">
\[C_B(t) = \frac{k_1}{k_2 - k_1} C_{A,0} \left[\exp(-k_1 t) - \exp(-k_2 t) \right]\]</div>
<div class="math notranslate nohighlight">
\[C_C(t) = C_{A,0} - \frac{k_2}{k_2 - k_1} C_{A,0} \exp(-k_1 t) + \frac{k_1}{k_2 - k_1} \exp(-k_2 t) C_{A,0} = C_{A,0} - C_{A}(t) - C_{B}(t)\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">batch_rxn_model</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">CA0</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    </span>
<span class="sd">    Predict batch reaction performance</span>
<span class="sd">    </span>
<span class="sd">    Arugments:</span>
<span class="sd">        t: time, [hour], scalar or Numpy array</span>
<span class="sd">        theta: fitted parameters: A1, A2, E1, E2</span>
<span class="sd">        CA0: initial concentration, [mol/L], scalar or numpy array</span>
<span class="sd">        T: temperature, [K], scalar or Numpy array</span>
<span class="sd">    Returns:</span>
<span class="sd">        CA, CB, CC: Concentrations at times t, [mol/L], three scalars or numpy arrays</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">kinetics</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Computes kinetics from Arrhenius equation</span>
<span class="sd">        Arguments:</span>
<span class="sd">            A: pre-exponential factor, [1 / hr]</span>
<span class="sd">            E: activation energy, [kJ / mol]</span>
<span class="sd">            T: temperature, [K]</span>
<span class="sd">        Returns:</span>
<span class="sd">            k: reaction rate coefficient, [1/hr] or [1/hr*L/mol]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">R</span> <span class="o">=</span> <span class="mf">8.31446261815324</span> <span class="c1"># J / K / mole</span>

        <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">E</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">T</span><span class="p">))</span>

    <span class="c1"># units: [1/hr]</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="n">kinetics</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">T</span><span class="p">)</span>

    <span class="c1"># units: [1/hr]</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">kinetics</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">T</span><span class="p">)</span>

    <span class="c1"># units: [mol / L]</span>
    <span class="n">CA</span> <span class="o">=</span> <span class="n">CA0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">);</span>
    <span class="n">CB</span> <span class="o">=</span> <span class="n">k1</span><span class="o">*</span><span class="n">CA0</span><span class="o">/</span><span class="p">(</span><span class="n">k2</span><span class="o">-</span><span class="n">k1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">));</span>
    <span class="n">CC</span> <span class="o">=</span> <span class="n">CA0</span> <span class="o">-</span> <span class="n">CA</span> <span class="o">-</span> <span class="n">CB</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">CA</span><span class="p">,</span> <span class="n">CB</span><span class="p">,</span> <span class="n">CC</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s test the code by running it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">theta_true</span> <span class="o">=</span> <span class="p">[</span><span class="mf">85.</span><span class="p">,</span> <span class="mf">370.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>
<span class="n">time_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span> <span class="c1"># hr</span>
<span class="n">CA0_exp1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># mol/L</span>
<span class="n">T_exp1</span> <span class="o">=</span> <span class="mi">400</span> <span class="c1"># K</span>
<span class="n">CA_exp1</span><span class="p">,</span> <span class="n">CB_exp1</span><span class="p">,</span> <span class="n">CC_exp1</span> <span class="o">=</span> <span class="n">batch_rxn_model</span><span class="p">(</span><span class="n">theta_true</span><span class="p">,</span> <span class="n">time_exp</span><span class="p">,</span> <span class="n">CA0_exp1</span><span class="p">,</span> <span class="n">T_exp1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="generate-synthetic-experimental-dataset">
<h2><span class="section-number">16.1.4. </span>Generate Synthetic Experimental Dataset<a class="headerlink" href="#generate-synthetic-experimental-dataset" title="Link to this heading">#</a></h2>
<p>Let’s construct a dataset containing:</p>
<ul class="simple">
<li><p>Batch experiment at <span class="math notranslate nohighlight">\(T=400\)</span> K and <span class="math notranslate nohighlight">\(C_{AO}=1.0\)</span> mol/L</p></li>
<li><p>Batch experiment at <span class="math notranslate nohighlight">\(T=300\)</span> K and <span class="math notranslate nohighlight">\(C_{AO}=3.0\)</span> mol/L</p></li>
</ul>
<p>We also simulated the first experiment. Let’s simulate the second.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">theta_true</span> <span class="o">=</span> <span class="p">[</span><span class="mf">85.</span><span class="p">,</span> <span class="mf">370.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>
<span class="n">CA0_exp2</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="c1"># mol/L</span>
<span class="n">T_exp2</span> <span class="o">=</span> <span class="mi">300</span> <span class="c1"># K</span>
<span class="n">CA_exp2</span><span class="p">,</span> <span class="n">CB_exp2</span><span class="p">,</span> <span class="n">CC_exp2</span> <span class="o">=</span> <span class="n">batch_rxn_model</span><span class="p">(</span><span class="n">theta_true</span><span class="p">,</span> <span class="n">time_exp</span><span class="p">,</span> <span class="n">CA0_exp2</span><span class="p">,</span> <span class="n">T_exp2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next let’s add random normally distributed noise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_exp</span><span class="p">)</span>

<span class="n">noise_std_dev</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="n">CA_exp1</span> <span class="o">+=</span> <span class="n">noise_std_dev</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_time</span><span class="p">)</span>
<span class="n">CA_exp2</span> <span class="o">+=</span> <span class="n">noise_std_dev</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_time</span><span class="p">)</span>
<span class="n">CB_exp1</span> <span class="o">+=</span> <span class="n">noise_std_dev</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_time</span><span class="p">)</span>
<span class="n">CB_exp2</span> <span class="o">+=</span> <span class="n">noise_std_dev</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_time</span><span class="p">)</span>
<span class="n">CC_exp1</span> <span class="o">+=</span> <span class="n">noise_std_dev</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_time</span><span class="p">)</span>
<span class="n">CC_exp2</span> <span class="o">+=</span> <span class="n">noise_std_dev</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_time</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we’ll package these into a numpy array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create empty array for experiment 1</span>
<span class="n">exp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_time</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="c1"># Assign 1 to column 0. This is the experiment number.</span>
<span class="n">exp1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Copy CA0 into column 1</span>
<span class="n">exp1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CA0_exp1</span>

<span class="c1"># Copy T into column 2 </span>
<span class="n">exp1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_exp1</span>

<span class="c1"># Copy time data into column 3</span>
<span class="n">exp1</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_exp</span>

<span class="c1"># Copy concentration data into remaining columns</span>
<span class="n">exp1</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">CA_exp1</span>
<span class="n">exp1</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">CB_exp1</span>
<span class="n">exp1</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">CC_exp1</span>

<span class="nb">print</span><span class="p">(</span><span class="n">exp1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 1.00000000e+00  1.00000000e+00  4.00000000e+02  0.00000000e+00
   1.07330538e+00 -1.73656971e-02  6.63565147e-02]
 [ 1.00000000e+00  1.00000000e+00  4.00000000e+02  1.00000000e-01
   4.07322347e-01  4.96785209e-01  1.22818333e-01]
 [ 1.00000000e+00  1.00000000e+00  4.00000000e+02  2.00000000e-01
   8.28389000e-02  4.19866422e-01  3.76212670e-01]
 [ 1.00000000e+00  1.00000000e+00  4.00000000e+02  3.00000000e-01
   5.90799142e-02  4.31187212e-01  4.79736696e-01]
 [ 1.00000000e+00  1.00000000e+00  4.00000000e+02  4.00000000e-01
  -2.00161740e-02  3.26774028e-01  7.12349757e-01]
 [ 1.00000000e+00  1.00000000e+00  4.00000000e+02  5.00000000e-01
  -3.56245472e-02  2.62694835e-01  7.27054197e-01]
 [ 1.00000000e+00  1.00000000e+00  4.00000000e+02  6.00000000e-01
   1.44852876e-02  4.21891814e-02  9.22226989e-01]
 [ 1.00000000e+00  1.00000000e+00  4.00000000e+02  7.00000000e-01
   2.80191186e-03  1.06483796e-01  8.48191581e-01]
 [ 1.00000000e+00  1.00000000e+00  4.00000000e+02  8.00000000e-01
   4.74370466e-03  5.97742592e-02  9.90692790e-01]
 [ 1.00000000e+00  1.00000000e+00  4.00000000e+02  9.00000000e-01
  -9.81051326e-02  1.04631939e-02  9.24865577e-01]
 [ 1.00000000e+00  1.00000000e+00  4.00000000e+02  1.00000000e+00
   5.09340585e-02 -3.86005366e-02  9.26026256e-01]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create empty array for experiment 2</span>
<span class="n">exp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_time</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="c1"># Assign 2 to column 0. This is the experiment number.</span>
<span class="n">exp2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Copy CA0 into column 1</span>
<span class="n">exp2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CA0_exp2</span>

<span class="c1"># Copy T into column 2 </span>
<span class="n">exp2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_exp2</span>

<span class="c1"># Copy time data into column 3</span>
<span class="n">exp2</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_exp</span>

<span class="c1"># Copy concentration data into remaining columns</span>
<span class="n">exp2</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">CA_exp2</span>
<span class="n">exp2</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">CB_exp2</span>
<span class="n">exp2</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">CC_exp2</span>

<span class="nb">print</span><span class="p">(</span><span class="n">exp2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[2.00000000e+00 3.00000000e+00 3.00000000e+02 0.00000000e+00
  3.03032330e+00 3.46743034e-02 7.48390441e-02]
 [2.00000000e+00 3.00000000e+00 3.00000000e+02 1.00000000e-01
  2.01053896e+00 9.72455517e-01 1.49644042e-03]
 [2.00000000e+00 3.00000000e+00 3.00000000e+02 2.00000000e-01
  1.28796917e+00 1.55828468e+00 7.25268353e-02]
 [2.00000000e+00 3.00000000e+00 3.00000000e+02 3.00000000e-01
  8.27077853e-01 1.89394720e+00 3.22703321e-01]
 [2.00000000e+00 3.00000000e+00 3.00000000e+02 4.00000000e-01
  5.08443272e-01 1.86275905e+00 5.02866094e-01]
 [2.00000000e+00 3.00000000e+00 3.00000000e+02 5.00000000e-01
  3.94949438e-01 1.97022256e+00 6.43069416e-01]
 [2.00000000e+00 3.00000000e+00 3.00000000e+02 6.00000000e-01
  2.15062932e-01 1.88979026e+00 8.89368985e-01]
 [2.00000000e+00 3.00000000e+00 3.00000000e+02 7.00000000e-01
  1.09264454e-01 1.83822195e+00 1.01858633e+00]
 [2.00000000e+00 3.00000000e+00 3.00000000e+02 8.00000000e-01
  1.70273100e-01 1.74271922e+00 1.14970870e+00]
 [2.00000000e+00 3.00000000e+00 3.00000000e+02 9.00000000e-01
  9.16208254e-02 1.57388833e+00 1.30139948e+00]
 [2.00000000e+00 3.00000000e+00 3.00000000e+02 1.00000000e+00
  1.27436637e-01 1.50854813e+00 1.51276171e+00]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Vertically stack data</span>
<span class="n">exps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">exp1</span><span class="p">,</span><span class="n">exp2</span><span class="p">))</span>

<span class="c1"># Create a dataframe with specific columns</span>
<span class="c1"># Pro Tip: Use &#39;temp&#39; for temeprature instead of &#39;T&#39;.</span>
<span class="c1">#   &#39;T&#39; can be confused with transpose.</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">exps</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;CA0&#39;</span><span class="p">,</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span><span class="s1">&#39;CB&#39;</span><span class="p">,</span><span class="s1">&#39;CC&#39;</span><span class="p">])</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>exp</th>
      <th>CA0</th>
      <th>temp</th>
      <th>time</th>
      <th>CA</th>
      <th>CB</th>
      <th>CC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>400.0</td>
      <td>0.0</td>
      <td>1.073305</td>
      <td>-0.017366</td>
      <td>0.066357</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>400.0</td>
      <td>0.1</td>
      <td>0.407322</td>
      <td>0.496785</td>
      <td>0.122818</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>400.0</td>
      <td>0.2</td>
      <td>0.082839</td>
      <td>0.419866</td>
      <td>0.376213</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>400.0</td>
      <td>0.3</td>
      <td>0.059080</td>
      <td>0.431187</td>
      <td>0.479737</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>400.0</td>
      <td>0.4</td>
      <td>-0.020016</td>
      <td>0.326774</td>
      <td>0.712350</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Finally, let’s plot the data and the true model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_data_and_model</span><span class="p">(</span><span class="n">theta_</span><span class="p">,</span> <span class="n">data1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot regression results</span>

<span class="sd">    Args:</span>
<span class="sd">        theta: model parameters</span>
<span class="sd">        data: Pandas data frame</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># Set axed font size</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># loop over experiments</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data1</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>

        <span class="c1">## Plot 1: Data Versus Prediction</span>
        
        <span class="c1"># delcare figure object</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="c1"># select the rows that correspond to the specific experiment number</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">exp</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># determine experiment conditions</span>
        <span class="n">CA0_</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">CA0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">())</span>
        <span class="n">T_</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">())</span>
        
        <span class="c1"># Plot dataset 1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">data1</span><span class="o">.</span><span class="n">CA</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;$C_</span><span class="si">{A}</span><span class="s2">$ Data&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">data1</span><span class="o">.</span><span class="n">CB</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;$C_</span><span class="si">{B}</span><span class="s2">$ Data&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">data1</span><span class="o">.</span><span class="n">CC</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;$C_</span><span class="si">{C}</span><span class="s2">$ Data&quot;</span><span class="p">)</span>

        
        <span class="c1"># determine time set</span>
        <span class="n">t_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span><span class="mi">21</span><span class="p">)</span>
        
        <span class="c1"># Evaluate model</span>
        <span class="n">CA_</span><span class="p">,</span> <span class="n">CB_</span><span class="p">,</span> <span class="n">CC_</span> <span class="o">=</span> <span class="n">batch_rxn_model</span><span class="p">(</span><span class="n">theta_</span><span class="p">,</span><span class="n">t_plot</span><span class="p">,</span><span class="n">CA0_</span><span class="p">,</span><span class="n">T_</span><span class="p">)</span>
        
        <span class="c1"># Plot model predictions</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_plot</span><span class="p">,</span> <span class="n">CA_</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;$C_</span><span class="si">{A}</span><span class="s2">$ Model&quot;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_plot</span><span class="p">,</span> <span class="n">CB_</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;$C_</span><span class="si">{B}</span><span class="s2">$ Model&quot;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_plot</span><span class="p">,</span> <span class="n">CC_</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;$C_</span><span class="si">{C}</span><span class="s2">$ Model&quot;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># Add &quot;extras&quot; to the plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time [hours]&quot;</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Concentration [mol L$^{-1}$]&quot;</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Experiment &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;:  T=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">T_</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; K,  CA$_0$=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">CA0_</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; mol L$^{-1}$&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        
        <span class="c1"># define tick size</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_data_and_model</span><span class="p">(</span><span class="n">theta_true</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6409008f5c60f05b075967cb1a3b101f1ab9214cb505cfdb92a64c707915530e.png" src="../../_images/6409008f5c60f05b075967cb1a3b101f1ab9214cb505cfdb92a64c707915530e.png" />
<img alt="../../_images/8bb732d5c79b13e73ef2bfe9fe18ebdaa56df0667f5b117815ca1eb13af9cae3.png" src="../../_images/8bb732d5c79b13e73ef2bfe9fe18ebdaa56df0667f5b117815ca1eb13af9cae3.png" />
</div>
</div>
</section>
<section id="perform-nonlinear-regression">
<h2><span class="section-number">16.1.5. </span>Perform Nonlinear Regression<a class="headerlink" href="#perform-nonlinear-regression" title="Link to this heading">#</a></h2>
<p>We esimate the unknown model parameters from data by solving a (weighted) nonlinear regression problem.</p>
<div class="amsmath math notranslate nohighlight" id="equation-e3206a31-8400-4116-adde-adeaca5a9802">
<span class="eqno">(16.1)<a class="headerlink" href="#equation-e3206a31-8400-4116-adde-adeaca5a9802" title="Permalink to this equation">#</a></span>\[\begin{equation}
\hat{\mathbf{\theta}} = \operatorname*{argmin}_{\underline{\theta}~\leq~\theta~\leq~\overline{\theta}} \sum_{d} \left(\mathbf{y}_d - f(\mathbf{\theta}, \mathbf{x}_d) \right)^\intercal \mathbf{W}_d \left(\mathbf{y}_d - f(\mathbf{\theta}, \mathbf{x}_d) \right)
\end{equation}\]</div>
<p>Here <span class="math notranslate nohighlight">\(y_d = C_{B,d}\)</span> is the measured data, <span class="math notranslate nohighlight">\(\mathbf{f}(\cdot,\cdot)\)</span> is the mathematical model, <span class="math notranslate nohighlight">\(\mathbf{\theta} = [A_1, A_2, E_1, E_2]\)</span> are the regressed parameters, <span class="math notranslate nohighlight">\(\mathbf{x} = [C_{A0}, T, t]\)</span> are the conditions for each data point (experiment) <span class="math notranslate nohighlight">\(d\)</span>, and <span class="math notranslate nohighlight">\(\mathbf{W} = \mathbf{I}\)</span> is the weight matrix. For the code below, we are minimizing the sum of squared error using only data for <span class="math notranslate nohighlight">\(C_B\)</span>.</p>
<section id="solve-nonlinear-least-squares-problem">
<h3><span class="section-number">16.1.5.1. </span>Solve Nonlinear Least Squares Problem<a class="headerlink" href="#solve-nonlinear-least-squares-problem" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># nonlinear parameter estimation with full physics model</span>
<span class="k">def</span> <span class="nf">regression_func</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to define regression function for least-squares fitting</span>
<span class="sd">    </span>
<span class="sd">    Note: This only uses CB measurements</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        theta: parameter vector</span>
<span class="sd">        data: Pandas data frame</span>
<span class="sd">    Returns:</span>
<span class="sd">        e: residual vector</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># determine number of entries in data frame</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># initialize matrix of residuals</span>
    <span class="c1"># rows: each row of Pandas data frame</span>
    <span class="c1"># columns: species CA, CB, CC</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># loop over experiments</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>

        <span class="c1"># select the rows that correspond to the specific experiment number</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">exp</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># determine experiment conditions</span>
        <span class="n">CA0_</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">CA0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">())</span>
        <span class="n">T_</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">())</span>

        <span class="c1"># determine experiment time</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">CA</span><span class="p">,</span> <span class="n">CB</span><span class="p">,</span> <span class="n">CC</span> <span class="o">=</span> <span class="n">batch_rxn_model</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">CA0_</span><span class="p">,</span><span class="n">T_</span><span class="p">)</span>

        <span class="c1"># Only use CB measurements</span>
        <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">CB</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">CB</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">e</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s test our function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">e_test</span> <span class="o">=</span> <span class="n">regression_func</span><span class="p">(</span><span class="n">theta_true</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">e_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0.0173657  -0.02647976  0.08611161 -0.0152367  -0.01741918 -0.043441
  0.10923293 -0.00343846  0.00974479  0.03619475  0.06981694 -0.0346743
  0.00872662 -0.01749875 -0.06312433  0.08774574 -0.00580498  0.0246635
 -0.01057614 -0.02141178  0.03251863 -0.01876837]
</pre></div>
</div>
</div>
</div>
<p>Finally, we can compute the best fit estimate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial guess</span>
<span class="n">theta0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">85.</span><span class="p">,</span> <span class="mf">370.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>

<span class="c1"># Bounds</span>
<span class="n">bnds</span> <span class="o">=</span> <span class="p">([</span><span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,],</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>

<span class="c1"># Define function that includes data</span>
<span class="n">my_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">theta_</span> <span class="p">:</span> <span class="n">regression_func</span><span class="p">(</span><span class="n">theta_</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="c1"># Perform nonlinear least squares</span>
<span class="n">nl_results</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span><span class="n">my_func</span><span class="p">,</span> <span class="n">theta0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trf&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Iteration     Total nfev        Cost      Cost reduction    Step norm     Optimality   
       0              1         2.2477e-02                                    8.50e-02    
       1              2         2.2148e-02      3.30e-04       5.04e+00       8.77e-03    
       2              3         2.1796e-02      3.52e-04       2.12e+01       1.42e-02    
       3              4         2.1765e-02      3.15e-05       1.96e+00       3.07e-04    
       4              5         2.1732e-02      3.29e-05       2.52e+00       1.26e-04    
       5              6         2.1731e-02      1.05e-06       8.33e-02       1.68e-05    
       6              7         2.1731e-02      1.39e-08       1.25e-03       9.82e-08    
       7              8         2.1731e-02      9.37e-17       4.26e-06       2.79e-09    
`gtol` termination condition is satisfied.
Function evaluations 8, initial cost 2.2477e-02, final cost 2.1731e-02, first-order optimality 2.79e-09.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">theta_hat</span> <span class="o">=</span> <span class="n">nl_results</span><span class="o">.</span><span class="n">x</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;theta_hat =&quot;</span><span class="p">,</span><span class="n">theta_hat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>theta_hat = [ 89.52352889 400.           7.62016597  15.17465026]
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-results">
<h3><span class="section-number">16.1.5.2. </span>Visualize Results<a class="headerlink" href="#visualize-results" title="Link to this heading">#</a></h3>
<p>First let’s plot the data and model predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_data_and_model</span><span class="p">(</span><span class="n">theta_hat</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/be954299b2fed48f178029ccfd45c0a5bcf924d3ad3d47dc24d9803f9e7a3aa8.png" src="../../_images/be954299b2fed48f178029ccfd45c0a5bcf924d3ad3d47dc24d9803f9e7a3aa8.png" />
<img alt="../../_images/df33df50d1ec6a5be3f0f62f48e70dcfe91915789d0e3a767f1de50562efd152.png" src="../../_images/df33df50d1ec6a5be3f0f62f48e70dcfe91915789d0e3a767f1de50562efd152.png" />
</div>
</div>
<p>Next, let’s look at the residuals. Recall, we only used <span class="math notranslate nohighlight">\(C_{B}\)</span> in our regression formulation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CB_residuals</span> <span class="o">=</span> <span class="n">regression_func</span><span class="p">(</span><span class="n">theta_hat</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="c1"># define font size</span>
<span class="n">fs</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">CB_residuals</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$C_</span><span class="si">{B}</span><span class="s2">$ residuals [mol L$^{-1}$]&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span><span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span><span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="c1"># define tick size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="o">-</span><span class="mf">0.07</span><span class="p">,</span><span class="mf">0.07</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.06</span><span class="p">,</span><span class="mf">0.07</span><span class="p">,</span><span class="mf">0.03</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># finish plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a6837286dcabfe1fce19f9940255f46efe44be83b008bb151c28e731e3b27745.png" src="../../_images/a6837286dcabfe1fce19f9940255f46efe44be83b008bb151c28e731e3b27745.png" />
</div>
</div>
</section>
<section id="estimate-uncertainty">
<h3><span class="section-number">16.1.5.3. </span>Estimate Uncertainty<a class="headerlink" href="#estimate-uncertainty" title="Link to this heading">#</a></h3>
<p>First let’s estimate the variance of the residuals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sigre</span> <span class="o">=</span> <span class="p">(</span><span class="n">CB_residuals</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">CB_residuals</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CB_residuals</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta_hat</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>How does the standard deviation of the residuals compare to the standard deviation of the measurement noise?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estimated Standard Deviation of Residuals =&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigre</span><span class="p">),</span><span class="s2">&quot;mol/L&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Standard Deviation of Measurement Error in Synthetic Data =&quot;</span><span class="p">,</span><span class="n">noise_std_dev</span><span class="p">,</span><span class="s2">&quot;mol/L&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estimated Standard Deviation of Residuals = 0.049137624893656175 mol/L
Standard Deviation of Measurement Error in Synthetic Data = 0.05 mol/L
</pre></div>
</div>
</div>
</div>
<p>Estimating the covariance matrix using a linearization approximation is easy!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Sigma_theta</span> <span class="o">=</span> <span class="n">sigre</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">nl_results</span><span class="o">.</span><span class="n">jac</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">nl_results</span><span class="o">.</span><span class="n">jac</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Covariance matrix:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">Sigma_theta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Covariance matrix:
 [[ 2.77141940e+03 -9.72902361e+02  7.77883866e+01 -5.94859480e+00]
 [-9.72902361e+02  1.29273200e+04 -2.65789266e+01  8.23859555e+01]
 [ 7.77883866e+01 -2.65789266e+01  2.18854666e+00 -1.61348238e-01]
 [-5.94859480e+00  8.23859555e+01 -1.61348238e-01  5.28489135e-01]]
</pre></div>
</div>
</div>
</div>
<p>Recall the rows/colums are <span class="math notranslate nohighlight">\(A_1\)</span>, <span class="math notranslate nohighlight">\(A_2\)</span>, <span class="math notranslate nohighlight">\(E_1\)</span>, and <span class="math notranslate nohighlight">\(E_2\)</span>.</p>
<p>We can easily convert this to a correlation matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">corr_theta</span> <span class="o">=</span> <span class="n">Sigma_theta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_hat</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_hat</span><span class="p">)):</span>
        <span class="n">corr_theta</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_theta</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Sigma_theta</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Sigma_theta</span><span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">])</span>
        
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation matrix:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">corr_theta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation matrix:
 [[ 1.         -0.16254136  0.99881656 -0.15543372]
 [-0.16254136  1.         -0.15801754  0.99673774]
 [ 0.99881656 -0.15801754  1.         -0.15002661]
 [-0.15543372  0.99673774 -0.15002661  1.        ]]
</pre></div>
</div>
</div>
</div>
<p><strong>Discussion:</strong> Why are the pairs <span class="math notranslate nohighlight">\(A_1\)</span>, <span class="math notranslate nohighlight">\(E_2\)</span> and <span class="math notranslate nohighlight">\(A_2\)</span>, <span class="math notranslate nohighlight">\(E_2\)</span> highly correlated when measuring only <span class="math notranslate nohighlight">\(C_B\)</span>?</p>
</section>
</section>
<section id="fisher-information-matrix">
<h2><span class="section-number">16.1.6. </span>Fisher Information Matrix<a class="headerlink" href="#fisher-information-matrix" title="Link to this heading">#</a></h2>
<p>What is the value of measuring other physical quantities such as <span class="math notranslate nohighlight">\(C_A\)</span> or <span class="math notranslate nohighlight">\(C_C\)</span> in this example?</p>
<p>How can we systematically determine the most informative set of experiments?</p>
<p>The remainder of this notebook develops a mathematical framework to answer these (and related) questions.</p>
<section id="model-sensitivity">
<h3><span class="section-number">16.1.6.1. </span>Model Sensitivity<a class="headerlink" href="#model-sensitivity" title="Link to this heading">#</a></h3>
<p>The first step of calculating the Fisher Information Matrix (FIM) is computing the sensitivity of all model outputs to each model parameter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_model_output</span><span class="p">(</span><span class="n">theta_</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Assembles matrix out model outputs (columns) by experimental conditions (rows)</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        theta_: values of theta parameters, numpy array</span>
<span class="sd">        data: data frame of experimental conditions</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        model_output: matrix</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># Allocate matrix of model outputs</span>
    <span class="n">model_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
    
    <span class="c1"># Iterate over rows in pandas dataframe (each row is an experiment)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="c1"># Evaluate model and store results</span>
        <span class="n">model_output</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">batch_rxn_model</span><span class="p">(</span><span class="n">theta_</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">CA0</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">model_output</span>

<span class="c1"># Test function at nominal values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">calc_model_output</span><span class="p">(</span><span class="n">theta_hat</span><span class="p">,</span><span class="n">df</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 1.00000000e+00 -0.00000000e+00  0.00000000e+00]
 [ 4.04359390e-01  4.71983465e-01  1.23657145e-01]
 [ 1.63506516e-01  5.01791382e-01  3.34702102e-01]
 [ 6.61153952e-02  4.07750121e-01  5.26134484e-01]
 [ 2.67343809e-02  2.99829192e-01  6.73436427e-01]
 [ 1.08102979e-02  2.10144215e-01  7.79045487e-01]
 [ 4.37124548e-03  1.43544280e-01  8.52084474e-01]
 [ 1.76755416e-03  9.66294369e-02  9.01603009e-01]
 [ 7.14727120e-04  6.44932646e-02  9.34792008e-01]
 [ 2.89006622e-04  4.28251919e-02  9.56885801e-01]
 [ 1.16862541e-04  2.83494368e-02  9.71533701e-01]
 [ 3.00000000e+00 -0.00000000e+00  0.00000000e+00]
 [ 1.96746609e+00  9.83700121e-01  4.88337934e-02]
 [ 1.29030760e+00  1.54309287e+00  1.66599535e-01]
 [ 8.46212147e-01  1.83168855e+00  3.22099301e-01]
 [ 5.54964567e-01  1.94951127e+00  4.95524160e-01]
 [ 3.63957988e-01  1.96156445e+00  6.74477558e-01]
 [ 2.38691666e-01  1.90993601e+00  8.51372321e-01]
 [ 1.56539253e-01  1.82173268e+00  1.02172806e+00]
 [ 1.02661890e-01  1.71427939e+00  1.18305872e+00]
 [ 6.73279290e-02  1.59852535e+00  1.33414672e+00]
 [ 4.41551390e-02  1.48127445e+00  1.47457041e+00]]
</pre></div>
</div>
</div>
</div>
<p>We’ll use finite difference to estimate the sensitivities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_model_sensitivity</span><span class="p">(</span><span class="n">theta_</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Estimate the model sensitivity matrix using forward finite difference</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        model_function: Python function that computes model outputs</span>
<span class="sd">        theta_: nominal value of theta</span>
<span class="sd">        exp_design_df: data frame containing experimental data</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># Evaluate model at nominal point</span>
    <span class="n">nominal_output</span> <span class="o">=</span> <span class="n">calc_model_output</span><span class="p">(</span><span class="n">theta_</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    
    <span class="c1"># Extract number of experiments and number of measured/output variables</span>
    <span class="p">(</span><span class="n">n_exp</span><span class="p">,</span> <span class="n">n_output</span><span class="p">)</span> <span class="o">=</span> <span class="n">nominal_output</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="c1"># Set finite difference step size</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1E-5</span>
    
    <span class="c1"># Extract number of parameters</span>
    <span class="n">n_param</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta_</span><span class="p">)</span>
    
    <span class="c1"># Create list to store model sensitity matrices</span>
    <span class="n">model_sensitivity</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Loop over number of outputs</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_output</span><span class="p">):</span>
        
        <span class="c1"># Allocate empty sensitivty matrix</span>
        <span class="n">model_sensitivity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_exp</span><span class="p">,</span><span class="n">n_param</span><span class="p">)))</span>
    
    <span class="c1"># Loop over parameters</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_param</span><span class="p">):</span>
        
        <span class="c1"># Create perturbation vector</span>
        <span class="n">perturb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_param</span><span class="p">)</span>
        <span class="n">perturb</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">eps</span>
        
        <span class="c1"># Forward and backward perturbation simulations</span>
        <span class="n">output_forward</span> <span class="o">=</span> <span class="n">calc_model_output</span><span class="p">(</span><span class="n">theta_</span> <span class="o">+</span> <span class="n">perturb</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">output_backward</span> <span class="o">=</span> <span class="n">calc_model_output</span><span class="p">(</span><span class="n">theta_</span> <span class="o">-</span> <span class="n">perturb</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_forward</span> <span class="o">-</span> <span class="n">output_backward</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">eps</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">param &quot;</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sens:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">sensitivity</span><span class="p">)</span>
        
        <span class="c1"># Loop over outputs</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_output</span><span class="p">):</span>
            <span class="c1"># Copy sensitivity results</span>
            <span class="n">model_sensitivity</span><span class="p">[</span><span class="n">o</span><span class="p">][:,</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="p">[:,</span><span class="n">o</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">model_sensitivity</span>

<span class="n">model_sensitivity</span> <span class="o">=</span> <span class="n">calc_model_sensitivity</span><span class="p">(</span><span class="n">theta_hat</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CA sensitivity:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">model_sensitivity</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CB sensitivity:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">model_sensitivity</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CC sensitivity:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">model_sensitivity</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CA sensitivity:
 [[ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]
 [-4.08973715e-03  0.00000000e+00  1.10087602e-01  0.00000000e+00]
 [-3.30744724e-03  0.00000000e+00  8.90299115e-02  0.00000000e+00]
 [-2.00609602e-03  0.00000000e+00  5.40001210e-02  0.00000000e+00]
 [-1.08157835e-03  0.00000000e+00  2.91139413e-02  0.00000000e+00]
 [-5.46682953e-04  0.00000000e+00  1.47156195e-02  0.00000000e+00]
 [-2.65267663e-04  0.00000000e+00  7.14047869e-03  0.00000000e+00]
 [-1.25140715e-04  0.00000000e+00  3.36853954e-03  0.00000000e+00]
 [-5.78306552e-05  0.00000000e+00  1.55668639e-03  0.00000000e+00]
 [-2.63074145e-05  0.00000000e+00  7.08143355e-04  0.00000000e+00]
 [-1.18196112e-05  0.00000000e+00  3.18160461e-04  0.00000000e+00]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]
 [-9.27138054e-03  0.00000000e+00  3.32756203e-01  0.00000000e+00]
 [-1.21607512e-02  0.00000000e+00  4.36457696e-01  0.00000000e+00]
 [-1.19629328e-02  0.00000000e+00  4.29357857e-01  0.00000000e+00]
 [-1.04607398e-02  0.00000000e+00  3.75443121e-01  0.00000000e+00]
 [-8.57547947e-03  0.00000000e+00  3.07779837e-01  0.00000000e+00]
 [-6.74878601e-03  0.00000000e+00  2.42218556e-01  0.00000000e+00]
 [-5.16366962e-03  0.00000000e+00  1.85327642e-01  0.00000000e+00]
 [-3.87022661e-03  0.00000000e+00  1.38905086e-01  0.00000000e+00]
 [-2.85545235e-03  0.00000000e+00  1.02484142e-01  0.00000000e+00]
 [-2.08074284e-03  0.00000000e+00  7.46792867e-02  0.00000000e+00]]
CB sensitivity:
 [[ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]
 [ 3.07873165e-03 -2.66175046e-04 -8.28733420e-02  3.20134993e-02]
 [ 1.34287935e-03 -6.07406925e-04 -3.61476451e-02  7.30542616e-02]
 [-1.72985265e-04 -7.88588542e-04  4.65641992e-03  9.48454014e-02]
 [-8.57254454e-04 -8.17387005e-04  2.30755875e-02  9.83090598e-02]
 [-9.92934225e-04 -7.51696710e-04  2.67278175e-02  9.04083334e-02]
 [-8.78883599e-04 -6.42535961e-04  2.36578011e-02  7.72793131e-02]
 [-6.90748347e-04 -5.23129458e-04  1.85935737e-02  6.29180117e-02]
 [-5.08684211e-04 -4.11524686e-04  1.36927688e-02  4.94950431e-02]
 [-3.60213372e-04 -3.15630702e-04  9.69622864e-03  3.79616478e-02]
 [-2.48833728e-04 -2.37449162e-04  6.69810980e-03  2.85585699e-02]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]
 [ 8.79791077e-03 -1.18304205e-04 -3.15763048e-01  1.89716373e-02]
 [ 1.07608610e-02 -3.90302757e-04 -3.86214680e-01  6.25901788e-02]
 [ 9.61943550e-03 -7.28308736e-04 -3.45248135e-01  1.16793875e-01]
 [ 7.33999079e-03 -1.07940253e-03 -2.63437301e-01  1.73096381e-01]
 [ 4.89766858e-03 -1.41293043e-03 -1.75780683e-01  2.26581962e-01]
 [ 2.72624353e-03 -1.71236414e-03 -9.78467500e-02  2.74600093e-01]
 [ 9.75692482e-04 -1.97001464e-03 -3.50182728e-02  3.15917734e-01]
 [-3.43443718e-04 -2.18361210e-03  1.23264298e-02  3.50170895e-01]
 [-1.28148652e-03 -2.35410502e-03  4.59934290e-02  3.77511676e-01]
 [-1.90864652e-03 -2.48425414e-03  6.85026312e-02  3.98382796e-01]]
CC sensitivity:
 [[ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]
 [ 1.01100550e-03  2.66175046e-04 -2.72142604e-02 -3.20134993e-02]
 [ 1.96456789e-03  6.07406925e-04 -5.28822664e-02 -7.30542616e-02]
 [ 2.17908129e-03  7.88588544e-04 -5.86565410e-02 -9.48454014e-02]
 [ 1.93883281e-03  8.17387008e-04 -5.21895289e-02 -9.83090598e-02]
 [ 1.53961718e-03  7.51696716e-04 -4.14434369e-02 -9.04083334e-02]
 [ 1.14415126e-03  6.42535963e-04 -3.07982798e-02 -7.72793131e-02]
 [ 8.15889062e-04  5.23129456e-04 -2.19621133e-02 -6.29180117e-02]
 [ 5.66514868e-04  4.11524687e-04 -1.52494552e-02 -4.94950431e-02]
 [ 3.86520788e-04  3.15630699e-04 -1.04043720e-02 -3.79616478e-02]
 [ 2.60653343e-04  2.37449160e-04 -7.01627026e-03 -2.85585699e-02]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]
 [ 4.73469769e-04  1.18304205e-04 -1.69931546e-02 -1.89716373e-02]
 [ 1.39989015e-03  3.90302757e-04 -5.02430163e-02 -6.25901788e-02]
 [ 2.34349725e-03  7.28308736e-04 -8.41097218e-02 -1.16793875e-01]
 [ 3.12074897e-03  1.07940253e-03 -1.12005820e-01 -1.73096381e-01]
 [ 3.67781090e-03  1.41293043e-03 -1.31999154e-01 -2.26581962e-01]
 [ 4.02254249e-03  1.71236414e-03 -1.44371806e-01 -2.74600093e-01]
 [ 4.18797714e-03  1.97001464e-03 -1.50309369e-01 -3.15917734e-01]
 [ 4.21367035e-03  2.18361210e-03 -1.51231516e-01 -3.50170895e-01]
 [ 4.13693888e-03  2.35410502e-03 -1.48477571e-01 -3.77511676e-01]
 [ 3.98938934e-03  2.48425414e-03 -1.43181918e-01 -3.98382796e-01]]
</pre></div>
</div>
</div>
</div>
<p>We are now ready to compute the FIM for each of the three measurements:</p>
<div class="math notranslate nohighlight">
\[
M_{i} = (\sigma^{-2}_{i}) \mathbf{Q}_{i}^{T} \mathbf{Q}_{i} \quad \forall i \in \{C_A, C_B, C_C \}
\]</div>
</section>
<section id="fim-by-measurement-type">
<h3><span class="section-number">16.1.6.2. </span>FIM By Measurement Type<a class="headerlink" href="#fim-by-measurement-type" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allocate list of FIM</span>
<span class="n">FIM</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">measurements</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">,</span><span class="s1">&#39;CB&#39;</span><span class="p">,</span><span class="s1">&#39;CC&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">measurements</span><span class="p">)):</span>
    <span class="n">FIM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">1</span><span class="o">/</span><span class="n">noise_std_dev</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">model_sensitivity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">model_sensitivity</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FIM for&quot;</span><span class="p">,</span><span class="n">measurements</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s2">&quot;measurements:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">FIM</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FIM for CA measurements:
 [[ 2.77135943e-01  0.00000000e+00 -9.82726797e+00  0.00000000e+00]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]
 [-9.82726797e+00  0.00000000e+00  3.49495231e+02  0.00000000e+00]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]] 

FIM for CB measurements:
 [[ 1.56846256e-01 -9.56610562e-03 -5.57644320e+00  1.55420093e+00]
 [-9.56610562e-03  1.21838382e-02  3.47843876e-01 -1.90081115e+00]
 [-5.57644320e+00  3.47843876e-01  1.98719040e+02 -5.63237399e+01]
 [ 1.55420093e+00 -1.90081115e+00 -5.63237399e+01  2.98442315e+02]] 

FIM for CC measurements:
 [[ 5.34873217e-02  2.49460063e-02 -1.85411508e+00 -3.88011717e+00]
 [ 2.49460063e-02  1.21838382e-02 -8.68404444e-01 -1.90081115e+00]
 [-1.85411508e+00 -8.68404444e-01  6.47801357e+01  1.36021753e+02]
 [-3.88011717e+00 -1.90081115e+00  1.36021753e+02  2.98442315e+02]] 
</pre></div>
</div>
</div>
</div>
<p>Discussion:</p>
<ul class="simple">
<li><p>What would measuring only <span class="math notranslate nohighlight">\(C_{A}\)</span> only provide information about <span class="math notranslate nohighlight">\(A_1\)</span> and <span class="math notranslate nohighlight">\(E_1\)</span>?</p></li>
<li><p>If you could only choose to measure ONE species (<span class="math notranslate nohighlight">\(C_A\)</span>, <span class="math notranslate nohighlight">\(C_B\)</span>, or <span class="math notranslate nohighlight">\(C_C\)</span>), which would you choose and why?</p></li>
</ul>
</section>
<section id="combined-fim">
<h3><span class="section-number">16.1.6.3. </span>Combined FIM<a class="headerlink" href="#combined-fim" title="Link to this heading">#</a></h3>
<p>Assuming the measurement errors across species are independent, we can compute a FIM for measuring all three species with simple addition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FIM_total</span> <span class="o">=</span> <span class="n">FIM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">FIM</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">FIM</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">FIM_total</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 4.87469521e-01  1.53799007e-02 -1.72578263e+01 -2.32591624e+00]
 [ 1.53799007e-02  2.43676764e-02 -5.20560568e-01 -3.80162230e+00]
 [-1.72578263e+01 -5.20560568e-01  6.12994406e+02  7.96980132e+01]
 [-2.32591624e+00 -3.80162230e+00  7.96980132e+01  5.96884631e+02]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FIM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FIM_total</span><span class="p">)</span>
<span class="n">measurements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="eigendecomposition">
<h3><span class="section-number">16.1.6.4. </span>Eigendecomposition<a class="headerlink" href="#eigendecomposition" title="Link to this heading">#</a></h3>
<p>Next let us interpret the eigendecomposition of each FIM. For simplicity, we can going to drop the index <span class="math notranslate nohighlight">\(i\)</span>. Recall <span class="math notranslate nohighlight">\(\mathbf{M} \in \mathbb{R}^{m \times m}\)</span> because <span class="math notranslate nohighlight">\(\mathbf{\theta} \in \mathbb{R}^{m}\)</span>.</p>
<div class="amsmath math notranslate nohighlight" id="equation-a71c2d99-2b05-4b88-b39c-0887c816ca76">
<span class="eqno">(16.2)<a class="headerlink" href="#equation-a71c2d99-2b05-4b88-b39c-0887c816ca76" title="Permalink to this equation">#</a></span>\[\begin{equation}
\mathbf{M} = \mathbf{W} \mathbf{\Lambda} \mathbf{W}^{-1}, \quad \mathbf{W} = \begin{bmatrix} \mathbf{v}_{1} \cdots \mathbf{v}_{p} \end{bmatrix}, \quad \mathbf{\Lambda} = \begin{bmatrix} \lambda_1 &amp; \cdots &amp; 0 \\ \vdots &amp; \ddots &amp; \vdots \\ 0 &amp; \cdots &amp; \lambda_p \end{bmatrix} 
\end{equation}\]</div>
<p>Here <span class="math notranslate nohighlight">\(\mathbf{W} \in \mathbb{R}^{m \times m}\)</span> is the matrix of eigenvectors <span class="math notranslate nohighlight">\(\mathbf{v}_{1},\ldots,\mathbf{v}_{p}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{\Lambda} \in \mathbb{R}^{m \times m}\)</span> is a diagonal matrix containing the corresponding eigenvalues <span class="math notranslate nohighlight">\(\lambda_1,\ldots,\lambda_p\)</span>. Because <span class="math notranslate nohighlight">\(\mathbf{M}\)</span> is a <a class="reference external" href="https://en.wikipedia.org/wiki/Eigendecomposition_of_a_matrix#Real_symmetric_matrices">real symmetric matrix</a> by definition, <span class="math notranslate nohighlight">\(\mathbf{W}^{-1} = \mathbf{W}^\intercal\)</span>, and the eigendecomposition can be written as follows:</p>
<div class="amsmath math notranslate nohighlight" id="equation-189ea8df-054f-4ba7-8b1d-3848df611eba">
<span class="eqno">(16.3)<a class="headerlink" href="#equation-189ea8df-054f-4ba7-8b1d-3848df611eba" title="Permalink to this equation">#</a></span>\[\begin{equation}
\mathbf{M} = \sum_{k=1}^{p} \lambda_{k} \mathbf{v}_{k} \mathbf{v}_{k}^\intercal
\end{equation}\]</div>
<p>Now back to the example!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create empty dictionary to store eigendecompositions</span>
<span class="n">eigendecompositions</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measurements</span><span class="p">):</span>
    
    <span class="c1"># Create empty matrix</span>
    <span class="n">results_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    
    <span class="c1"># Compute eigendecomposition</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">FIM</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;**********</span><span class="se">\n</span><span class="s2">Considering measurement&quot;</span><span class="p">,</span><span class="n">measurements</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">eigenvalue =&quot;</span><span class="p">,</span><span class="n">w</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;eigenvector:&quot;</span><span class="p">,</span><span class="n">v</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span>
        
        <span class="c1"># Store results</span>
        <span class="n">results_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">results_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;**********</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">eigendecompositions</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results_matrix</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;eigenvalue&#39;</span><span class="p">,</span><span class="s1">&#39;A1&#39;</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">,</span> <span class="s1">&#39;E1&#39;</span><span class="p">,</span> <span class="s1">&#39;E2&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>**********
Considering measurement CA 

eigenvalue = 0.0
eigenvector: [0. 1. 0. 0.]

eigenvalue = 0.0
eigenvector: [0. 0. 0. 1.]

eigenvalue = 0.0008076542403046005
eigenvector: [0.99960491 0.         0.02810742 0.        ]

eigenvalue = 349.77155897475797
eigenvector: [-0.02810742  0.          0.99960491  0.        ]
**********

**********
Considering measurement CB 

eigenvalue = 7.417670951499084e-05
eigenvector: [-0.094524    0.99549899 -0.0025974   0.0063425 ]

eigenvalue = 0.00036021877561471074
eigenvector: [9.95126558e-01 9.45571481e-02 2.79570296e-02 6.96125711e-04]

eigenvalue = 173.47263113156728
eigenvector: [ 0.02563466  0.00267488 -0.91127572 -0.41098938]

eigenvalue = 323.8573199861445
eigenvector: [ 0.01145476 -0.00579237 -0.41083844  0.9116178 ]
**********

**********
Considering measurement CC 

eigenvalue = 4.310703517123985e-06
eigenvector: [-0.38866152  0.92129245 -0.01127041  0.00595148]

eigenvalue = 0.0004773233523595857
eigenvector: [0.92086687 0.38882297 0.02861687 0.00140608]

eigenvalue = 2.3049147942710224
eigenvector: [ 0.02836407 -0.00184186 -0.90822132  0.41752379]

eigenvalue = 360.98272594326806
eigenvector: [-0.01191266 -0.00578966  0.41735846  0.90864541]
**********

**********
Considering measurement all 

eigenvalue = 0.00012678747681498252
eigenvector: [-0.13608616  0.99066973 -0.00380749  0.00628778]

eigenvalue = 0.0016193519161382154
eigenvector: [0.99029772 0.13613577 0.02786513 0.00100537]

eigenvalue = 525.0316029650991
eigenvector: [ 0.01872698 -0.00471404 -0.66930479  0.74273695]

eigenvalue = 685.3575254093001
eigenvector: [-0.0209829  -0.00427851  0.74245547  0.66955305]
**********
</pre></div>
</div>
</div>
</div>
<p>We can also see the eigenvalues in Pandas DataFrames.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">eigendecompositions</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Eigendecomposition for measurement&quot;</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">eigendecompositions</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Eigendecomposition for measurement CA
   eigenvalue        A1   A2        E1   E2
0    0.000000  0.000000  1.0  0.000000  0.0
1    0.000000  0.000000  0.0  0.000000  1.0
2    0.000808  0.999605  0.0  0.028107  0.0
3  349.771559 -0.028107  0.0  0.999605  0.0 

Eigendecomposition for measurement CB
   eigenvalue        A1        A2        E1        E2
0    0.000074 -0.094524  0.995499 -0.002597  0.006342
1    0.000360  0.995127  0.094557  0.027957  0.000696
2  173.472631  0.025635  0.002675 -0.911276 -0.410989
3  323.857320  0.011455 -0.005792 -0.410838  0.911618 

Eigendecomposition for measurement CC
   eigenvalue        A1        A2        E1        E2
0    0.000004 -0.388662  0.921292 -0.011270  0.005951
1    0.000477  0.920867  0.388823  0.028617  0.001406
2    2.304915  0.028364 -0.001842 -0.908221  0.417524
3  360.982726 -0.011913 -0.005790  0.417358  0.908645 

Eigendecomposition for measurement all
   eigenvalue        A1        A2        E1        E2
0    0.000127 -0.136086  0.990670 -0.003807  0.006288
1    0.001619  0.990298  0.136136  0.027865  0.001005
2  525.031603  0.018727 -0.004714 -0.669305  0.742737
3  685.357525 -0.020983 -0.004279  0.742455  0.669553 
</pre></div>
</div>
</div>
</div>
</section>
<section id="covariance-matrix-of-regressed-paramters">
<h3><span class="section-number">16.1.6.5. </span>Covariance Matrix of Regressed Paramters<a class="headerlink" href="#covariance-matrix-of-regressed-paramters" title="Link to this heading">#</a></h3>
<p>The covariance matrix <span class="math notranslate nohighlight">\(\mathbf{\Sigma_{\theta}}\)</span> is approximately the inverse of the Fisher information matrix <span class="math notranslate nohighlight">\(\mathbf{M}\)</span> (again dropping the measurement index <span class="math notranslate nohighlight">\(i\)</span> for simplicity):</p>
<div class="amsmath math notranslate nohighlight" id="equation-35f807b7-e6d9-42f9-a9c2-a1f932bb05db">
<span class="eqno">(16.4)<a class="headerlink" href="#equation-35f807b7-e6d9-42f9-a9c2-a1f932bb05db" title="Permalink to this equation">#</a></span>\[\begin{equation}
\mathbf{\Sigma_{\theta}} \approx \mathbf{M}^{-1} = \sigma^{2} \left(\mathbf{Q}^{\intercal} \mathbf{Q} \right)^{-1}
\end{equation}\]</div>
<p>What is we are able to measure the concentration of all of the species simultaneously? Under the assumption that the measurement errors are uncorrelated across measurement types, we can compute a total FIM as the sum of the contributions.</p>
<div class="amsmath math notranslate nohighlight" id="equation-09709774-6e42-4408-8c75-e095e92b8419">
<span class="eqno">(16.5)<a class="headerlink" href="#equation-09709774-6e42-4408-8c75-e095e92b8419" title="Permalink to this equation">#</a></span>\[\begin{equation}
\mathbf{\Sigma_{\theta}} \approx \left(\sum_{i\in \mathcal{I}} \mathbf{M}_{i}^{-1} \right)^{-1} = \left( \sum_{i\in \mathcal{I}} \sigma_{i}^{2} \left(\mathbf{Q}_{i}^{\intercal} \mathbf{Q}_{i} \right) \right)^{-1}, \quad \mathcal{I} = \{C_{A}, C_{B}, C_{C} \}
\end{equation}\]</div>
<p>Now let’s compute the covariance matrices (by measurement):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute covariance matrices from FIM</span>
<span class="n">cov_matrices</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FIM</span><span class="p">)):</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Invert FIM</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">FIM</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Covariance matrix considering only measurement&quot;</span><span class="p">,</span><span class="n">measurements</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>        
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="c1"># FIM is likely singular, skip printing</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear algebra error for measurement&quot;</span><span class="p">,</span> <span class="n">measurements</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cov_matrices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Linear algebra error for measurement CA
Covariance matrix considering only measurement CB 
 [[ 2.86955115e+03 -1.00735276e+03  8.05427561e+01 -6.15923775e+00]
 [-1.00735276e+03  1.33850558e+04 -2.75200852e+01  8.53031102e+01]
 [ 8.05427561e+01 -2.75200852e+01  2.26603983e+00 -1.67061677e-01]
 [-6.15923775e+00  8.53031102e+01 -1.67061677e-01  5.47202086e-01]] 

Covariance matrix considering only measurement CC 
 [[ 3.68190526e+04 -8.23154125e+04  1.07136010e+03 -5.33879033e+02]
 [-8.23154125e+04  1.97217257e+05 -2.38542446e+03  1.27310677e+03]
 [ 1.07136010e+03 -2.38542446e+03  3.15407239e+01 -1.56394151e+01]
 [-5.33879033e+02  1.27310677e+03 -1.56394151e+01  8.29883324e+00]] 

Covariance matrix considering only measurement all 
 [[ 7.51673028e+02 -9.80073759e+02  2.11273217e+01 -6.13409548e+00]
 [-9.80073759e+02  7.75216600e+03 -2.74077469e+01  4.92148384e+01]
 [ 2.11273217e+01 -2.74077469e+01  5.95490126e-01 -1.71746592e-01]
 [-6.13409548e+00  4.92148384e+01 -1.71746592e-01  3.14159031e-01]] 
</pre></div>
</div>
</div>
</div>
<p>How are the eigendecompositions of <span class="math notranslate nohighlight">\(\mathbf{M}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{\Sigma_{\theta}}\)</span> related?</p>
<ul class="simple">
<li><p>Eigenvectors are the same</p></li>
<li><p>Eigenvalues are inverses. If <span class="math notranslate nohighlight">\(\lambda_{k}\)</span> is an eigenvalue of <span class="math notranslate nohighlight">\(\mathbf{M}\)</span>, then <span class="math notranslate nohighlight">\(\lambda_{k}^{-1}\)</span> is an eigevalue of <span class="math notranslate nohighlight">\(\mathbf{\Sigma_{\theta}}\)</span>.</p></li>
</ul>
<p>For simplicity in this notebook, <span class="math notranslate nohighlight">\(\lambda_{k}\)</span> will always be an eigenvalue of <span class="math notranslate nohighlight">\(\mathbf{M}\)</span>.</p>
<p>We can also compute the correlation matrix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta_hat</span><span class="p">)</span>

<span class="c1"># Loop over the covariance matrices</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cov_matrices</span><span class="p">)):</span>
    
    <span class="c1"># Check that the matrix was not set to None (no linear algebra errors)</span>
    <span class="k">if</span> <span class="n">cov_matrices</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Grab covariance matrix</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">cov_matrices</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
        
        <span class="c1"># Create an emptry correlation matrix</span>
        <span class="n">cor_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        <span class="c1"># Loop over rows</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="c1"># Loop over columns</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="c1"># Normalize the covariance by the two variances (diagonal elements) to </span>
                <span class="c1"># compute the correlation coefficint</span>
                <span class="n">cor_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">cov</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation matrix for measurement&quot;</span><span class="p">,</span><span class="n">measurements</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">cor_matrix</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation matrix for measurement CB 
 [[ 1.         -0.16254159  0.99881656 -0.15543403]
 [-0.16254159  1.         -0.15801776  0.99673774]
 [ 0.99881656 -0.15801776  1.         -0.15002692]
 [-0.15543403  0.99673774 -0.15002692  1.        ]] 

Correlation matrix for measurement CC 
 [[ 1.         -0.96598948  0.99417614 -0.96582411]
 [-0.96598948  1.         -0.95643924  0.99513924]
 [ 0.99417614 -0.95643924  1.         -0.96666537]
 [-0.96582411  0.99513924 -0.96666537  1.        ]] 

Correlation matrix for measurement all 
 [[ 1.         -0.40600627  0.99860257 -0.39917311]
 [-0.40600627  1.         -0.40338944  0.99726312]
 [ 0.99860257 -0.40338944  1.         -0.39707823]
 [-0.39917311  0.99726312 -0.39707823  1.        ]] 
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualizing-confidence-ellipses">
<h3><span class="section-number">16.1.6.6. </span>Visualizing Confidence Ellipses<a class="headerlink" href="#visualizing-confidence-ellipses" title="Link to this heading">#</a></h3>
<p>Moreover, we can visualize the covariance matrix <span class="math notranslate nohighlight">\(\mathbf{\Sigma_{\theta}}\)</span> as an elipitical confidence region were the axes of the ellipse at the eigenvectors <span class="math notranslate nohighlight">\(\mathbf{v}_{i}\)</span> and the length of the axes are the eigenvalues <span class="math notranslate nohighlight">\(\lambda_{k}^{-1}\)</span>. The following code was adapted from this <a class="reference external" href="https://matplotlib.org/stable/gallery/statistics/confidence_ellipse.html">excellent example</a> which is based on this <a class="reference external" href="https://carstenschelp.github.io/2018/09/14/Plot_Confidence_Ellipse_001.html">excellent explanation of the underlying linear algebra</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Ellipse</span>
<span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">))</span>

<span class="c1"># Define font size</span>
<span class="n">fs</span><span class="o">=</span><span class="mi">20</span>

<span class="c1"># Define colors for measurements</span>
<span class="n">measurement_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;purple&#39;</span><span class="p">]</span>

<span class="c1"># Number of standard deviations for confidence ellipses</span>
<span class="n">n_std</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Define names of parameters</span>
<span class="n">theta_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$A_1$&#39;</span><span class="p">,</span> <span class="s1">&#39;$A_2$&#39;</span><span class="p">,</span> <span class="s1">&#39;$E_1$&#39;</span><span class="p">,</span> <span class="s1">&#39;$E_2$&#39;</span><span class="p">]</span>


<span class="c1"># Loop over rows</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
    <span class="c1"># Loop over columns -- subdiagonal</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="c1"># Create subplots below the diagonal</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Plot theta estimate</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">theta_hat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">theta_hat</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">theta_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">theta_labels</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        
        <span class="c1"># define tick size</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">max_scale_x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_scale_y</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># loop over measurements</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FIM</span><span class="p">)):</span>
            
            <span class="c1"># Check not None</span>
            <span class="k">if</span> <span class="n">cov_matrices</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
                <span class="c1"># Select rows from cov</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">cov_matrices</span><span class="p">[</span><span class="n">m</span><span class="p">][(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),:]</span>

                <span class="c1"># Select columns from FIM</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[:,(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span>
            
                <span class="c1"># Draw non-dimensionalized</span>
                <span class="n">pearson</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ell_radius_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">pearson</span><span class="p">)</span>
                <span class="n">ell_radius_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pearson</span><span class="p">)</span>
                <span class="n">ellipse</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">ell_radius_x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">ell_radius_y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                                      <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="n">measurement_colors</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

                <span class="c1"># Calculating the standard deviation of x from</span>
                <span class="c1"># the squareroot of the variance and multiplying</span>
                <span class="c1"># with the given number of standard deviations.</span>
                <span class="n">scale_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">n_std</span>

                <span class="c1"># calculating the standard deviation of y</span>
                <span class="n">scale_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">n_std</span>

                <span class="c1"># transforming ellipse</span>
                <span class="n">transf</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Affine2D</span><span class="p">()</span> \
                    <span class="o">.</span><span class="n">rotate_deg</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> \
                    <span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">)</span> \
                    <span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">theta_hat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta_hat</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                
                <span class="c1"># Plot ellipse</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
                <span class="n">ellipse</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="n">transf</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
                
                <span class="c1"># Keep track of limits</span>
                <span class="n">max_scale_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">scale_x</span><span class="p">,</span><span class="n">max_scale_x</span><span class="p">])</span>
                <span class="n">max_scale_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">scale_y</span><span class="p">,</span><span class="n">max_scale_y</span><span class="p">])</span>
        
        <span class="c1"># Adjust plot limits</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">theta_hat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_scale_x</span><span class="p">,</span> <span class="n">theta_hat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_scale_x</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">theta_hat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_scale_y</span><span class="p">,</span> <span class="n">theta_hat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_scale_y</span><span class="p">])</span>
        
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2ff559ce9667da5125361c858ae2e9dd4b153fd3cf86f9493263ac3253633d16.png" src="../../_images/2ff559ce9667da5125361c858ae2e9dd4b153fd3cf86f9493263ac3253633d16.png" />
</div>
</div>
<p>The above plot shows the projected confidence ellipses considering only measurment <span class="math notranslate nohighlight">\(C_B\)</span> (green), only measurement <span class="math notranslate nohighlight">\(C_C\)</span> (red), and all measurments (purple). With only measurment <span class="math notranslate nohighlight">\(C_A\)</span>, the Fisher information is not invertable and the covariance matrix is not defined, hence there is no blue ellipse.</p>
</section>
<section id="discussion">
<h3><span class="section-number">16.1.6.7. </span>Discussion<a class="headerlink" href="#discussion" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Why are the red ellipses (measurement <span class="math notranslate nohighlight">\(C_C\)</span> only) the largest?</p></li>
<li><p>Why are the purple ellipses (all measurements) the smallest?</p></li>
<li><p>Why are some ellipses so skinny?</p></li>
<li><p>Why are the ellipses tilted? Why do some have a positive tilt and others have a negative tilt?</p></li>
</ol>
</section>
<section id="model-identifiability">
<h3><span class="section-number">16.1.6.8. </span>Model Identifiability<a class="headerlink" href="#model-identifiability" title="Link to this heading">#</a></h3>
<p>If model predictions <span class="math notranslate nohighlight">\(\mathbf{f}(\mathbf{x}_d,\mathbf{\theta})\)</span> are insensitivite to <span class="math notranslate nohighlight">\(\mathbf{\theta}_j\)</span>, then:</p>
<ul class="simple">
<li><p>Sensitivity matrix <span class="math notranslate nohighlight">\(\mathbf{Q}\)</span>, Fisher information <span class="math notranslate nohighlight">\(\mathbf{M}\)</span>, and the covariance <span class="math notranslate nohighlight">\(\mathbf{\Sigma_\theta}\)</span> matrices are (numerically) rank deficient</p></li>
<li><p>At least one one eigenvalue of <span class="math notranslate nohighlight">\(\mathbf{M}\)</span> is (near-)zero and it’s corresponding eigenvector predominently points in the direction of <span class="math notranslate nohighlight">\(\theta_j\)</span></p></li>
<li><p>The data <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> cannot uniquely identify <span class="math notranslate nohighlight">\(\theta_j\)</span> in model <span class="math notranslate nohighlight">\(\mathbf{f}\)</span></p></li>
<li><p>There is large uncertainty in <span class="math notranslate nohighlight">\(\theta_j\)</span> (and corresponding elements of the covariance matrix <span class="math notranslate nohighlight">\(\mathbf{\Sigma_\theta}\)</span>)</p></li>
</ul>
<p>Practical steps to overcome model identifiability:</p>
<ol class="arabic simple">
<li><p>Interpret the eigenvectors. Reformulate the model to remove any redundant parameters. For example, one cannot uniquely estimate <span class="math notranslate nohighlight">\(\theta_1 \cdot \theta_2\)</span> but may be able to estimate a new lumped parameter <span class="math notranslate nohighlight">\(\theta_3 := \theta_1 \cdot \theta_2\)</span> instead of the two original parameters.</p></li>
<li><p>Fix non-identifiable (a.k.a., sloppy) parameters based on literature and other prior information</p></li>
<li><p>Using your model and Fisher information matrix analysis, determine if measuring other physical quantities would make your model identifiable.</p></li>
</ol>
</section>
<section id="optimality-metrics">
<h3><span class="section-number">16.1.6.9. </span>Optimality metrics<a class="headerlink" href="#optimality-metrics" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">optimality_metrics</span><span class="p">(</span><span class="n">FIM</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Compute optimality metrics using eigenvalues</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        FIM: numpy array</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        dopt, aopt, eopt (float)</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># Compute eigendecomposition</span>
    <span class="c1"># Compute eigendecomposition</span>
    <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">FIM</span><span class="p">)</span>
    
    <span class="c1"># Determinant </span>
    <span class="n">dopt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span>
    
    <span class="c1"># Trace</span>
    <span class="n">aopt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span>
    
    <span class="c1"># Min eigenvalue</span>
    <span class="n">eopt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;D-optimality =&quot;</span><span class="p">,</span><span class="n">dopt</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A-optimality =&quot;</span><span class="p">,</span><span class="n">aopt</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;E-optimality =&quot;</span><span class="p">,</span><span class="n">eopt</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">dopt</span><span class="p">,</span> <span class="n">aopt</span><span class="p">,</span> <span class="n">eopt</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">measurements</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;**********</span><span class="se">\n</span><span class="s2">Considering measurement&quot;</span><span class="p">,</span><span class="n">measurements</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">optimality_metrics</span><span class="p">(</span><span class="n">FIM</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;**********</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>**********
Considering measurement CA 
D-optimality = 0.0
A-optimality = 349.77236662899827
E-optimality = 0.0
**********

**********
Considering measurement CB 
D-optimality = 0.0015011309979356335
A-optimality = 497.3303855131969
E-optimality = 7.417670951499084e-05
**********

**********
Considering measurement CC 
D-optimality = 1.711993579475809e-06
A-optimality = 363.28812237159497
E-optimality = 4.310703517123985e-06
**********

**********
Considering measurement all 
D-optimality = 0.07387886756768279
A-optimality = 1210.3908745137921
E-optimality = 0.00012678747681498252
**********
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="what-is-the-next-best-experiment">
<h2><span class="section-number">16.1.7. </span>What is the next best experiment?<a class="headerlink" href="#what-is-the-next-best-experiment" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">temperatures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
<span class="n">intial_concentrations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>

<span class="c1"># Allocate lists and empty arrays</span>
<span class="n">Dopt</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Aopt</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Eopt</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">measurements</span><span class="p">)):</span>
    <span class="n">empty_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">intial_concentrations</span><span class="p">)))</span>
    <span class="n">Dopt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty_matrix</span><span class="p">)</span>
    <span class="n">Aopt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">Eopt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

<span class="c1"># Loop over proposed temperatures</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">T</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">temperatures</span><span class="p">):</span>
    <span class="c1"># Loop over proposed concentrations</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">C</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intial_concentrations</span><span class="p">):</span>
        
        <span class="c1"># Create df for new experiment</span>
        <span class="n">exp3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_time</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

        <span class="c1"># Assign 3 to column 0. This is the experiment number.</span>
        <span class="n">exp3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="c1"># Copy C into column 1</span>
        <span class="n">exp3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Copy T into column 2 </span>
        <span class="n">exp3</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Copy time data into column 3</span>
        <span class="n">exp3</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_exp</span>
           
        <span class="c1"># Create dataframe for new experiments</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">exp3</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;CA0&#39;</span><span class="p">,</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
             
        <span class="c1"># Calculate model sensitivities</span>
        <span class="n">model_sensitivity</span> <span class="o">=</span> <span class="n">calc_model_sensitivity</span><span class="p">(</span><span class="n">theta_hat</span><span class="p">,</span> <span class="n">new_df</span><span class="p">)</span>
        
        <span class="c1"># Allocate empty matrix for combined measurements</span>
        <span class="n">FIM_new_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        
        <span class="c1"># Loop over measurements</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">measurements</span><span class="p">)):</span>
            
            <span class="c1"># Skip &quot;all&quot; measuremnt </span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">measurements</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            
                <span class="c1"># Compute FIM of proposed experiment</span>
                <span class="n">FIM_new</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">noise_std_dev</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">model_sensitivity</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">model_sensitivity</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                
                <span class="c1"># Add to total</span>
                <span class="n">FIM_new_all</span> <span class="o">+=</span> <span class="n">FIM_new</span>
            
            <span class="c1"># All measurements</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">FIM_new</span> <span class="o">=</span> <span class="n">FIM_new_all</span>
            
    
            <span class="c1"># Compute total FIM (prior + new)</span>
            <span class="n">FIM_total</span> <span class="o">=</span> <span class="n">FIM</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">FIM_new</span>
                        
            <span class="c1"># Compute A and D-optimality</span>
            <span class="n">Dopt</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">FIM_total</span><span class="p">)</span>
            <span class="n">Aopt</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">FIM_total</span><span class="p">)</span>
            
            <span class="c1"># Compute E-optimality</span>
            <span class="n">smallest_eigenvalue</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">FIM_total</span><span class="p">,</span> <span class="n">eigvals_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subset_by_index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">Eopt</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">smallest_eigenvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s make a function that visualizes the MBDoE metrics as a heatmap.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_contour_plot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">zlabelstring</span><span class="p">,</span> <span class="n">clabel_fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%2.2f</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">intial_concentrations</span><span class="p">):</span>
    <span class="c1"># draw figure, using (6,6) because the plot is small otherwise</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    
    <span class="c1"># define font size</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># plot heatmap</span>
    <span class="c1">#   cmap defines the overall color within the heatmap </span>
    <span class="c1">#   levels: determines the number and positions of the contour lines / regions.</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1"># plot color bar</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>

    <span class="c1"># plot title in color bar</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">zlabelstring</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="c1"># set font size in color bar</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>

    <span class="c1"># plot equipotential line</span>
    <span class="c1">#  [::10] means sampling 1 in every 10 samples</span>
    <span class="c1">#  colors define the color want to use, &#39;k&#39; for black</span>
    <span class="c1">#  alpha is blending value, between 0 (transparent) and 1 (opaque).</span>
    <span class="c1">#  linestyle defines the linestyle.</span>
    <span class="c1">#  linewidth defines the width of line</span>
    <span class="n">cs2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">cs</span><span class="o">.</span><span class="n">levels</span><span class="p">[::</span><span class="mi">15</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># plot the heatmap label</span>
    <span class="c1">#  %2.2f means keep to 2 digit</span>
    <span class="c1">#  fontsize defines the size of the text in figure</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs2</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">clabel_fmt</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>

    <span class="c1"># define tick size</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># set squared figure</span>
    <span class="c1"># plt.axis(&#39;square&#39;)</span>
    
    <span class="c1"># Plot data from previous two experiments</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">T_exp1</span><span class="p">,</span> <span class="n">T_exp2</span><span class="p">],</span> <span class="p">[</span><span class="n">CA0_exp1</span><span class="p">,</span> <span class="n">CA0_exp2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># plot titile and x,y label</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature [K]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Initial Concentration [mol L$^{-1}$]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="a-optimality">
<h3><span class="section-number">16.1.7.1. </span>A-Optimality<a class="headerlink" href="#a-optimality" title="Link to this heading">#</a></h3>
<p>We’ll start by plotting A-optimality seperately for each of the three measurement types. The stars mark the prior two experiments. The colored contours show metrics of the FIM depending <span class="math notranslate nohighlight">\(T\)</span> and <span class="math notranslate nohighlight">\(C_{A0}\)</span> for the third experiment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">measurements_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$C_</span><span class="si">{A}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;$C_</span><span class="si">{B}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;$C_</span><span class="si">{C}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="s1">&#39;All Meas.&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measurements_labels</span><span class="p">):</span>
    <span class="n">create_contour_plot</span><span class="p">(</span><span class="n">Aopt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="s2">&quot;A-optimality for &quot;</span><span class="o">+</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%2.0f</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4c30f2e0267b428954a1cbc9b393038686679d27e018ac0c45614bc4c43a923f.png" src="../../_images/4c30f2e0267b428954a1cbc9b393038686679d27e018ac0c45614bc4c43a923f.png" />
<img alt="../../_images/b1a1702e895ec3a56fe03e2f9e0ce92b308ec53777c1640da805c5cba8b180be.png" src="../../_images/b1a1702e895ec3a56fe03e2f9e0ce92b308ec53777c1640da805c5cba8b180be.png" />
<img alt="../../_images/2d0c7ffd435ff1a518c2c60e47e1301193a1594359c804910167a48fa45535e0.png" src="../../_images/2d0c7ffd435ff1a518c2c60e47e1301193a1594359c804910167a48fa45535e0.png" />
<img alt="../../_images/5821b850d146b1012c615c0460e4dac5310a3901326f251ce18b88bcfc61968a.png" src="../../_images/5821b850d146b1012c615c0460e4dac5310a3901326f251ce18b88bcfc61968a.png" />
</div>
</div>
</section>
<section id="d-optimality">
<h3><span class="section-number">16.1.7.2. </span>D-Optimality<a class="headerlink" href="#d-optimality" title="Link to this heading">#</a></h3>
<p>Likewise, let’s make plots for D-optimality.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measurements_labels</span><span class="p">):</span>
    <span class="n">create_contour_plot</span><span class="p">(</span><span class="n">Dopt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="s2">&quot;D-optimality for &quot;</span><span class="o">+</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%2.4f</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f74ef394c72d57afacea62df8287ca83377aefaf7fbc03e8c9f798eb3bc267ba.png" src="../../_images/f74ef394c72d57afacea62df8287ca83377aefaf7fbc03e8c9f798eb3bc267ba.png" />
<img alt="../../_images/e7abffcea1763b53c1c4bda07e1777852570a7dc457d8dff4b2c0f5066a3a0d7.png" src="../../_images/e7abffcea1763b53c1c4bda07e1777852570a7dc457d8dff4b2c0f5066a3a0d7.png" />
<img alt="../../_images/60089cc40618b54e50e74e69113622c59577900609d57a8d7b3297e38c686f7f.png" src="../../_images/60089cc40618b54e50e74e69113622c59577900609d57a8d7b3297e38c686f7f.png" />
<img alt="../../_images/22264a9656cd90b81da8fc37d3bd3b562b0271324e83e2aee4a518ad8cdf316c.png" src="../../_images/22264a9656cd90b81da8fc37d3bd3b562b0271324e83e2aee4a518ad8cdf316c.png" />
</div>
</div>
</section>
<section id="e-optimality">
<h3><span class="section-number">16.1.7.3. </span>E-Optimality<a class="headerlink" href="#e-optimality" title="Link to this heading">#</a></h3>
<p>And finally E-optimality.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measurements_labels</span><span class="p">):</span>
    <span class="n">create_contour_plot</span><span class="p">(</span><span class="n">Eopt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="s2">&quot;E-optimality for &quot;</span><span class="o">+</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%2.4f</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/76d491a0ae80045df03cd84c07822c8bd7795906480d61e010162939b3d3abb0.png" src="../../_images/76d491a0ae80045df03cd84c07822c8bd7795906480d61e010162939b3d3abb0.png" />
<img alt="../../_images/64fc6d4ebd3ae94250f8d6e9a1581d884f05211461c07f19b244cd9381444658.png" src="../../_images/64fc6d4ebd3ae94250f8d6e9a1581d884f05211461c07f19b244cd9381444658.png" />
<img alt="../../_images/ac62d27977203ff6b5254b90e7123fea3d04f30dbe23e8126b90812c6dbec081.png" src="../../_images/ac62d27977203ff6b5254b90e7123fea3d04f30dbe23e8126b90812c6dbec081.png" />
<img alt="../../_images/19759ffee1e53f96befc3b8b0845ebff2740b85d4714f0f5d585b58821247f14.png" src="../../_images/19759ffee1e53f96befc3b8b0845ebff2740b85d4714f0f5d585b58821247f14.png" />
</div>
</div>
</section>
<section id="id1">
<h3><span class="section-number">16.1.7.4. </span>Discussion<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Based on the plots for D-, A-, and E-optimality, why is it a bad idea to only measure <span class="math notranslate nohighlight">\(C_{A}\)</span>? Using the mathematical model for the experiment, explain why this makes sense.</p></li>
<li><p>Why are D- and E-optimality one or more orders of magnitude larger for measuring <span class="math notranslate nohighlight">\(C_{B}\)</span> instead of <span class="math notranslate nohighlight">\(C_{C}\)</span>?</p></li>
<li><p>Why do D- and E-optimality both recommend a third experiment at the maximum value for <span class="math notranslate nohighlight">\(C_{A0}\)</span>? Using the mathematical model and assumed measurement error structure, explain why this makes sense.</p></li>
<li><p>Why do A-, D-, and E-optimality recommend a third experiment at low, medium, and high temperatures, respectively? Which one should we choose if we can only do one more experiment?</p></li>
</ul>
</section>
</section>
<section id="take-away-messages">
<h2><span class="section-number">16.1.8. </span>Take Away Messages<a class="headerlink" href="#take-away-messages" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Fisher information matrix quantifies the value of data in the context of a mathematical model</p></li>
<li><p>An eigendecomposition of the Fisher information matrix reveals which parameters are (locally) not identiafiable</p></li>
<li><p>A-, D-, and E-optimality help inform which experimental conditions and measurements are most informative</p></li>
<li><p>Heatmaps of these optimality matrics help build intuition about the model</p></li>
</ul>
</section>
<section id="recommended-reading">
<h2><span class="section-number">16.1.9. </span>Recommended Reading<a class="headerlink" href="#recommended-reading" title="Link to this heading">#</a></h2>
<p><strong>Review:</strong></p>
<p>Franceschini, Gaia, and Sandro Macchietto. <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0009250907008871">Model-based design of experiments for parameter precision: State of the art</a> <em>Chemical Engineering Science</em> 63.19 (2008): 4846-4872.</p>
<p><strong>Software:</strong></p>
<p>Wang, Jialu, and Alexander W. Dowling. <a class="reference external" href="https://aiche.onlinelibrary.wiley.com/doi/full/10.1002/aic.17813">Pyomo.DoE: An open‐source package for model‐based design of experiments in Python</a> <em>AIChE Journal</em> 68.12 (2022): e17813.</p>
<p><strong>Applications at Notre Dame:</strong></p>
<p>Ouimet, Jonathan A., et al. <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0376738821006888">DATA: Diafiltration Apparatus for high-Throughput Analysis</a> <em>Journal of Membrane Science</em> 641 (2022): 119743.</p>
<p>Ghosh, Kanishka, Sergio Vernuccio, and Alexander W. Dowling. <a class="reference external" href="https://www.frontiersin.org/articles/10.3389/fceng.2022.898685/full">Nonlinear Reactor Design Optimization With Embedded Microkinetic Model Information</a> <em>Frontiers in Chemical Engineering</em> 4 (2022): 898685.</p>
<p>Liu, Xinhong, et al. <a class="reference external" href="https://dowlinglab.nd.edu/assets/449451/pse2021_diafiltration_doe_paper_vf_preprint.pdf">Accelerating Membrane Characterization with Model-Based Design of Experiments</a> <em>Computer Aided Chemical Engineering</em> 49 (2022): 859-864.</p>
<p>Liu, Xinhong, et al. <a class="reference external" href="https://dowlinglab.nd.edu/assets/478074/pse2021_reactive_ink_preprint.pdf">Mathematical Modelling of Reactive Inks for Additive Manufacturing of Charged Membranes</a> <em>Computer Aided Chemical Engineering</em> 49 (2022): 1063-1068.</p>
<p>Garciadiego, Alejandro, et al. <a class="reference external" href="https://chemrxiv.org/engage/api-gateway/chemrxiv/assets/orp/resource/item/6299694a468a08331949d774/original/what-data-are-most-valuable-to-screen-ionic-liquid-entrainers-for-hydrofluorocarbon-refrigerant-reuse-and-recycling.pdf">What data are most valuable to screen ionic liquid entrainers for hydrofluorocarbon refrigerant reuse and recycling?</a> <em>Industrial &amp; Engineering Chemistry Research</em> accepted (2022).</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/16"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="design_of_experiments.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">16. </span>Design of Experiments</p>
      </div>
    </a>
    <a class="right-next"
       href="../../fall2022/home.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Fall 2022</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">16.1.1. Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-modules">16.1.2. Import Modules</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-model-for-reaction-kinetics-example">16.1.3. Mathematical Model for Reaction Kinetics Example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-synthetic-experimental-dataset">16.1.4. Generate Synthetic Experimental Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-nonlinear-regression">16.1.5. Perform Nonlinear Regression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solve-nonlinear-least-squares-problem">16.1.5.1. Solve Nonlinear Least Squares Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-results">16.1.5.2. Visualize Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-uncertainty">16.1.5.3. Estimate Uncertainty</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fisher-information-matrix">16.1.6. Fisher Information Matrix</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-sensitivity">16.1.6.1. Model Sensitivity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fim-by-measurement-type">16.1.6.2. FIM By Measurement Type</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combined-fim">16.1.6.3. Combined FIM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#eigendecomposition">16.1.6.4. Eigendecomposition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#covariance-matrix-of-regressed-paramters">16.1.6.5. Covariance Matrix of Regressed Paramters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-confidence-ellipses">16.1.6.6. Visualizing Confidence Ellipses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion">16.1.6.7. Discussion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-identifiability">16.1.6.8. Model Identifiability</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optimality-metrics">16.1.6.9. Optimality metrics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-the-next-best-experiment">16.1.7. What is the next best experiment?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-optimality">16.1.7.1. A-Optimality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-optimality">16.1.7.2. D-Optimality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#e-optimality">16.1.7.3. E-Optimality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">16.1.7.4. Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#take-away-messages">16.1.8. Take Away Messages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-reading">16.1.9. Recommended Reading</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alexander Dowling, Ryan McClarren, Yamil Colón, et al.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>